# 系统架构文档

## 1. 系统概览

```
┌─────────────────────────────────────────────────────────────┐
│                      区块链网络层                              │
│  ┌──────────────┐         ┌──────────────┐                  │
│  │   Sepolia    │         │ Base Sepolia │                  │
│  │   Testnet    │         │   Testnet    │                  │
│  └──────┬───────┘         └──────┬───────┘                  │
│         │                        │                           │
└─────────┼────────────────────────┼───────────────────────────┘
          │                        │
          │  RPC 连接              │  RPC 连接
          │                        │
┌─────────▼────────────────────────▼───────────────────────────┐
│                      Go 后端服务                              │
│                                                               │
│  ┌─────────────────────────────────────────────────────┐    │
│  │              事件监听器 (Listener)                    │    │
│  │  - 监听 Transfer 事件                                 │    │
│  │  - 监听 TokenMinted 事件                             │    │
│  │  - 监听 TokenBurned 事件                             │    │
│  │  - 6区块延迟确认机制                                  │    │
│  └─────────────────────┬───────────────────────────────┘    │
│                        │                                     │
│  ┌─────────────────────▼───────────────────────────────┐    │
│  │           余额重建服务 (Repository)                   │    │
│  │  - 计算用户余额                                       │    │
│  │  - 记录余额变动                                       │    │
│  │  - 事务管理                                           │    │
│  └─────────────────────┬───────────────────────────────┘    │
│                        │                                     │
│  ┌─────────────────────▼───────────────────────────────┐    │
│  │         积分计算服务 (Points Calculator)              │    │
│  │  - 定时任务（每小时）                                  │    │
│  │  - 基于余额变化计算积分                                │    │
│  │  - 记录计算历史                                       │    │
│  └─────────────────────┬───────────────────────────────┘    │
│                        │                                     │
└────────────────────────┼─────────────────────────────────────┘
                         │
                         │  数据持久化
                         │
┌────────────────────────▼─────────────────────────────────────┐
│                    PostgreSQL 数据库                          │
│                                                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ user_balances│  │  user_points │  │balance_changes│      │
│  │  用户余额表  │  │  用户积分表   │  │ 余额变动表    │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│                                                               │
│  ┌──────────────┐  ┌──────────────┐                        │
│  │points_calc   │  │  sync_state  │                        │
│  │ 积分计算记录 │  │  同步状态表   │                        │
│  └──────────────┘  └──────────────┘                        │
└───────────────────────────────────────────────────────────────┘
```

## 2. 核心组件

### 2.1 智能合约层

**MyToken.sol**
- 基于 OpenZeppelin ERC20 实现
- 继承 Ownable 进行权限管理
- 提供 mint/burn 功能
- 发出自定义事件：TokenMinted、TokenBurned

```
合约方法：
├── mint(address to, uint256 amount)        - 铸造代币
├── burn(uint256 amount)                    - 销毁代币
├── burnFrom(address from, uint256 amount)  - 从指定地址销毁
└── 标准 ERC20 方法 (transfer, approve, etc.)

合约事件：
├── Transfer(address from, address to, uint256 value)
├── TokenMinted(address to, uint256 amount, uint256 timestamp)
└── TokenBurned(address from, uint256 amount, uint256 timestamp)
```

### 2.2 配置管理层 (config/)

**config.go**
- 从环境变量加载配置
- 支持多链配置
- 管理数据库连接参数
- 业务参数配置（确认区块数、积分比率）

```go
type Config struct {
    DBConfig          // 数据库配置
    Chains []ChainConfig  // 多链配置
    ConfirmationBlocks    // 确认区块数
    PointsRate            // 积分比率
}
```

### 2.3 数据访问层 (repository/)

**repository.go**
- 封装所有数据库操作
- 提供事务支持
- CRUD操作接口
- 数据查询方法

主要方法：
```go
// 同步状态管理
- GetOrCreateSyncState()
- UpdateSyncState()

// 余额管理
- GetUserBalance()
- UpdateUserBalance()
- RecordBalanceChange()

// 积分管理
- GetUserPoints()
- UpdateUserPoints()
- RecordPointsCalculation()

// 确认机制
- ConfirmBalanceChanges()
```

### 2.4 事件监听层 (listener/)

**listener.go**
- 连接区块链节点
- 扫描新区块
- 解析合约事件
- 6区块延迟确认

工作流程：
```
1. 每12秒检查新区块
2. 批量获取日志（每次最多1000区块）
3. 解析事件类型
4. 更新余额和记录变动
5. 标记确认状态（延迟6个区块）
```

事件处理流程：
```
Transfer 事件:
├── 提取 from/to/amount
├── 跳过 mint/burn (零地址)
├── 更新转出方余额 (减少)
└── 更新接收方余额 (增加)

TokenMinted 事件:
├── 提取 to/amount
└── 增加接收方余额

TokenBurned 事件:
├── 提取 from/amount
└── 减少持有方余额
```

### 2.5 积分计算层 (service/)

**points_calculator.go**
- 使用 cron 定时任务
- 每小时执行一次
- 基于余额变化精确计算积分

计算逻辑：
```
对于时间段 [t1, t2]:
├── 获取该时间段的余额变动记录
├── 分段计算：
│   ├── 时间段1: balance1 * duration1 * rate
│   ├── 时间段2: balance2 * duration2 * rate
│   └── ...
└── 累加总积分

积分公式：
points = balance * hours * (annual_rate / 8760)
```

## 3. 数据流

### 3.1 事件捕获流程

```
区块链事件
    ↓
[Listener] 扫描区块
    ↓
解析事件日志
    ↓
[Repository] 开始事务
    ↓
记录余额变动 → balance_changes
    ↓
更新用户余额 → user_balances
    ↓
提交事务
    ↓
更新同步状态 → sync_state
```

### 3.2 积分计算流程

```
定时触发 (每小时)
    ↓
获取所有用户列表
    ↓
对于每个用户:
    ├── 获取上次计算时间
    ├── 查询时间段内的余额变动
    ├── 分段计算积分
    ├── 记录计算历史 → points_calculations
    └── 更新总积分 → user_points
```

### 3.3 区块确认流程

```
新区块产生 (N)
    ↓
扫描并记录事件 (confirmed=false)
    ↓
等待6个区块
    ↓
当前区块 = N+6
    ↓
标记 N 区块的事件为已确认 (confirmed=true)
    ↓
已确认事件可用于积分计算
```

## 4. 数据模型

### 4.1 实体关系图

```
┌─────────────────┐
│  user_balances  │
│  用户余额表      │
├─────────────────┤
│ chain_name      │────┐
│ user_address    │    │
│ balance         │    │
│ updated_at      │    │
└─────────────────┘    │
                       │ 1:N
                       │
┌─────────────────┐    │
│ balance_changes │    │
│  余额变动表      │◄───┘
├─────────────────┤
│ chain_name      │
│ user_address    │
│ change_type     │
│ amount          │
│ balance_before  │
│ balance_after   │
│ tx_hash         │
│ block_number    │
│ confirmed       │
└─────────────────┘
        │
        │ 用于计算
        ↓
┌─────────────────┐
│  user_points    │
│  用户积分表      │
├─────────────────┤
│ chain_name      │
│ user_address    │
│ total_points    │
│ last_calc_at    │
└─────────────────┘
        │
        │ 1:N
        ↓
┌─────────────────┐
│points_calculations│
│  积分计算记录    │
├─────────────────┤
│ chain_name      │
│ user_address    │
│ calc_time       │
│ balance_snapshot│
│ points_earned   │
└─────────────────┘
```

### 4.2 关键数据结构

**余额变动类型**:
- `transfer_in`: 转入（接收代币）
- `transfer_out`: 转出（发送代币）
- `mint`: 铸造（新增供应）
- `burn`: 销毁（减少供应）

**确认状态**:
- `confirmed=false`: 未确认（少于6个区块）
- `confirmed=true`: 已确认（超过6个区块）

## 5. 多链支持

### 5.1 链隔离

每条链的数据通过 `chain_name` 字段隔离：
- 独立的同步状态
- 独立的用户余额
- 独立的积分计算
- 共享数据库和代码逻辑

### 5.2 并发处理

每条链启动独立的 goroutine：
```go
for each chain {
    go startListener(chain)  // 独立监听器
}
go startPointsCalculator()   // 统一积分计算
```

## 6. 容错机制

### 6.1 区块回滚保护

**6区块延迟确认**
- 新事件标记为 `confirmed=false`
- 等待6个区块后才确认
- 只有已确认的数据参与积分计算

### 6.2 数据一致性

**事务保证**
- 余额变动和余额更新在同一事务中
- 失败自动回滚
- 防止数据不一致

### 6.3 重启恢复

**同步状态持久化**
- 记录最后同步的区块号
- 重启后从上次位置继续
- 避免重复处理或遗漏

### 6.4 错误处理

```
错误类型：
├── RPC连接错误 → 记录日志，等待下次重试
├── 数据库错误 → 回滚事务，记录日志
├── 解析错误 → 跳过该事件，记录日志
└── 业务逻辑错误 → 记录详细信息，继续处理其他
```

## 7. 性能优化

### 7.1 批量处理

- 每次扫描最多1000个区块
- 批量获取日志
- 减少RPC调用次数

### 7.2 数据库优化

- 合理的索引设计
- 连接池管理
- 事务批处理

### 7.3 并发控制

- 每条链独立goroutine
- WaitGroup管理生命周期
- Context控制优雅关闭

## 8. 可扩展性

### 8.1 添加新链

1. 在 `.env` 添加配置
2. 系统自动识别并启动监听
3. 无需修改代码

### 8.2 添加新事件类型

1. 在 `listener.go` 添加事件处理
2. 定义新的变动类型
3. 更新数据库schema（如需要）

### 8.3 添加API接口

1. 引入 Gin 或其他框架
2. 基于现有 Repository 实现
3. 参考 docs/API.md

## 9. 监控要点

### 9.1 关键指标

- 区块同步延迟
- 事件处理成功率
- 数据库查询性能
- 内存和CPU使用

### 9.2 日志级别

```
DEBUG: 详细的事件信息
INFO:  关键操作和状态
WARN:  可恢复的错误
ERROR: 需要关注的严重错误
```

## 10. 安全考虑

### 10.1 输入验证

- 地址格式验证
- 数值范围检查
- SQL注入防护（使用参数化查询）

### 10.2 权限控制

- 数据库用户权限最小化
- 私钥环境变量管理
- RPC节点访问控制

### 10.3 数据完整性

- 事务保证ACID特性
- 外键约束
- 唯一索引防止重复

---

本架构文档描述了系统的整体设计和实现细节。如有疑问，请参考代码注释或提交 Issue。

